[![GitHub CI](https://github.com/willgeorgetaylor/junit-reducer/actions/workflows/test.yml/badge.svg)](https://github.com/willgeorgetaylor/junit-reducer/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/willgeorgetaylor/junit-reducer/graph/badge.svg?token=08001J4XQH)](https://codecov.io/gh/willgeorgetaylor/junit-reducer)
[![Language](https://img.shields.io/badge/Language-Go-blue.svg)](https://golang.org/)
[![GitHub release](https://img.shields.io/github/tag/willgeorgetaylor/junit-reducer.svg?label=release)](https://github.com/willgeorgetaylor/junit-reducer/releases)
[![Go Report Card](https://goreportcard.com/badge/github.com/willgeorgetaylor/junit-reducer)](https://goreportcard.com/report/github.com/willgeorgetaylor/junit-reducer)

## junit-reducer

JUnit Reducer is a CLI tool that aggregates the [JUnit test XML reports](https://www.ibm.com/docs/en/developer-for-zos/14.1?topic=formats-junit-xml-format) from your CI runs and creates a single, averaged report set. This lets you download a smaller set of reports, during CI runs, to inform your test splitting.

<picture>
  <source media="(prefers-color-scheme: dark)" srcset="./diagram-dark.png">
  <img alt="Diagram explaining how junit-reducer turns multiple sets of JUnit reports into a single set of JUnit reports." src="./diagram-light.png">
</picture>

## Why?

As your test suite grows, you may want to start splitting tests between multiple test runners, to be **executed concurrently.** While it's relatively simple to divide up your test suites by files, using lines of code (LOC) as a proxy for test duration, the LOC metric is still just an approximation and will result in uneven individual (and therefore overall slower) test run times as your codebase and test suites change.

### Faster CI

The preferable approach for splitting test suites accurately is to use **recently reported test times,** and the most popular format for exchanging test data (including timings) between tools is the [JUnit XML reports format](https://www.ibm.com/docs/en/developer-for-zos/14.1?topic=formats-junit-xml-format). While JUnit itself is a Java project, the schema that defines JUnit reports is equally applicable to any language and reports can be generated by most testing frameworks for JavaScript, Ruby, Python etc.

In busier projects, CI will be uploading reports frequently, so even if you take a small time window (for example, the last 24 hours), you could end up with 20MB+ of test reports. These reports need to be **downloaded to every runner in your concurrency set,** only to then perform the same splitting operation to **yield the exact same time estimates.** This means unnecessary and expensive work is being performed by each concurrent runner, potentially delaying the total test time by minutes and increasing CI costs.

### Consistent inputs

In very busy projects, there is also a more **problematic race condition possible**, with larger downloads and test runners starting at different times. As CI runs from other commits upload their reports to the same remote source that you're downloading them from, if any of your concurrent runners download reports with different values, the input data is misaligned and the splitting operation is corrupted. However, because the download and splitting operation is being performed in a distributed manner, across all of the runners concurrently, this misalignment is not discoverable and it is likely that some tests in your run will be **skipped without you knowing it happened.**

## Usage

Download and extract the latest build for your target environment, from the [releases page](https://github.com/willgeorgetaylor/junit-reducer/releases).

For a complete list of arguments:

```bash
$./junit-reducer --help
```

```
Flags:
  -h, --help                          help for junit-reducer
      --exclude string                Pattern to exclude from input JUnit XML reports
      --include string                Pattern to find input JUnit XML reports (required) (default "./**/*.xml")
      --op-cases-time string          Operation for test cases time. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-assertions string   Operation for test suites assertions. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-errors string       Operation for test suites errors. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-failed string       Operation for test suites failed. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-skipped string      Operation for test suites skipped. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-tests string        Operation for test suites tests. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --op-suites-time string         Operation for test suites time. Options: "max", "mean", "median", "min", "mode" or "sum" (default "mean")
      --output-path string            Output path for synthetic JUnit XML reports (required) (default "./output/")
      --reduce-cases-by string        Reduce test cases by name, classname, or file. Options: "classname", "file" or "name" (default "name")
      --reduce-suites-by string       Reduce test suites by name or filepath or both. Options: "filepath", "name" or "name+filepath" (default "name+filepath")
      --rounding-mode string          Rounding mode for counts that should be integers. Options: "ceil", "floor" or "round" (default "round")
```

## Examples

### Basic usage

```bash
junit-reducer \
  --include="test-reports/**/*" \     # Input path for JUnit reports
  --output-path="avg-reports/"        # Output path for averaged reports
```

### Reduce by name

```bash
junit-reducer \
  --include="test-reports/**/*" \
  --output-path="avg-reports/" \
  --reduce-suites-by="name" \         # Grouping test suites by name
  --reduce-cases-by="classname"       # Grouping test cases by classname
```

### Reduce with non-average operations

```bash
junit-reducer \
  --include="test-reports/**/*" \
  --output-path="avg-reports/" \
  --op-suites-skipped="min" \         # Keeps min of skips across suites of same type
  --op-suites-failed="min" \          # Keeps min of failures across suites of same type
  --op-suites-errors="min" \          # Keeps min of errors across suites of same type
  --op-suites-tests="max" \           # Keeps max of tests across suites of same type
  --op-suites-assertions="max" \      # Keeps max of assertions across suites of same type
  --op-suites-time="mean" \           # Calculates mean of time across suites of same type
  --op-cases-time="mean"              # Calculates mean of time across cases of same type
```

### Rounding average counts

```bash
junit-reducer \
  --include="test-reports/**/*" \
  --output-path="avg-reports/" \
  --rounding-mode="floor"             # Specifies the rounding method
```